# Nominal Models
@testset "Nominal Models" begin
    data = CSV.File(joinpath(Econometrics.DATAPATH, "insure.csv"), select = [:insure, :age, :male, :nonwhite, :site]) |>
        DataFrame |>
        dropmissing |>
        (data -> categorical!(data, [:insure, :site]))
    model = fit(
        EconometricModel,
        @formula(insure ~ age + male + nonwhite + site),
        data,
        contrasts = Dict(:insure => DummyCoding(base = "Uninsure")),
        )
    @test sprint(show, model) ==
          "Probability Model for Nominal Response\nCategories: Uninsure, Indemnity, Prepaid\nNumber of observations: 615\nNull Loglikelihood: -555.85\nLoglikelihood: -534.36\nR-squared: 0.0387\nLR Test: 42.99 ∼ χ²(10) ⟹ Pr > χ² = 0.0000\nFormula: insure ~ 1 + age + male + nonwhite + site\n───────────────────────────────────────────────────────────────────────────────────────────────────\n                                       PE         SE       t-value  Pr > |t|       2.50%     97.50%\n───────────────────────────────────────────────────────────────────────────────────────────────────\ninsure: Indemnity ~ (Intercept)   1.28694     0.59232     2.17271     0.0302   0.123689   2.4502\ninsure: Indemnity ~ age           0.00779612  0.0114418   0.681372    0.4959  -0.0146743  0.0302666\ninsure: Indemnity ~ male         -0.451848    0.367486   -1.22957     0.2193  -1.17355    0.269855\ninsure: Indemnity ~ nonwhite     -0.217059    0.425636   -0.509965    0.6103  -1.05296    0.618843\ninsure: Indemnity ~ site: 2       1.21152     0.470506    2.57493     0.0103   0.287497   2.13554\ninsure: Indemnity ~ site: 3       0.207813    0.366293    0.56734     0.5707  -0.511547   0.927172\ninsure: Prepaid ~ (Intercept)     1.55666     0.596327    2.61041     0.0093   0.385533   2.72778\ninsure: Prepaid ~ age            -0.00394887  0.0115993  -0.340439    0.7336  -0.0267287  0.018831\ninsure: Prepaid ~ male            0.109846    0.365187    0.300793    0.7637  -0.607343   0.827035\ninsure: Prepaid ~ nonwhite        0.757718    0.419575    1.80592     0.0714  -0.0662835  1.58172\ninsure: Prepaid ~ site: 2         1.32456     0.469789    2.81947     0.0050   0.401941   2.24717\ninsure: Prepaid ~ site: 3        -0.380175    0.372819   -1.01973     0.3083  -1.11235    0.352001\n───────────────────────────────────────────────────────────────────────────────────────────────────"
    β, V, σ = coef(model), vcov(model), stderror(model)
    @test β ≈ [
        1.286943,
        0.0077961,
        -0.4518496,
        -0.2170589,
        1.211563,
        0.2078123,
        1.556656,
        -0.0039489,
        0.1098438,
        0.7577178,
        1.324599,
        -0.3801756,
    ] rtol = 1e-3
    @test V ≈
          [
        0.35084518 -0.00590456 -0.02519209 -0.01837512 -0.08995794 -0.08264268 0.29928937 -0.00510107 -0.02257270 -0.01585492 -0.07392512 -0.06808314
        -0.00590456 0.00013092 -0.00046225 -0.00028066 0.00041004 0.00040470 -0.00509454 0.00011354 -0.00039387 -0.00024122 0.00033847 0.00035236
        -0.02519209 -0.00046225 0.13504644 0.01565749 0.01009559 0.00933967 -0.02288847 -0.00039497 0.11365141 0.01369872 0.00945927 0.00802593
        -0.01837512 -0.00590456 -0.02519209 0.18116609 0.01886597 -0.02821348 -0.01638629 -0.00023179 0.01314666 0.15068111 0.01664999 -0.02345786
        -0.08995794 -0.00590456 -0.02519209 -0.01837512 0.22138224 0.064050660 -0.07438947 0.00035751 0.00845363 0.01594691 0.19895500 0.05189742
        -0.08264268 0.00040470 0.00933967 -0.02821348 0.06405066 0.134170290 -0.06796097 0.00034828 0.00826890 -0.02353016 0.05182727 0.11060487
        0.29928937 -0.00509454 -0.02288847 -0.01638629 -0.07438947 -0.06796097 0.35560782 -0.00601966 -0.02683161 -0.02105510 -0.08991231 -0.08165509
        -0.00510107 0.00011354 -0.00039497 -0.00023179 0.00035751 0.00034828 -0.00601966 0.00013455 -0.00047223 -0.00028680 0.00039990 0.0004179
        -0.02257270 -0.00039387 0.11365141 0.01314666 0.00845363 0.00826890 -0.02683161 -0.00047223 0.13336253 0.01625685 0.01101870 0.00922333
        -0.01585492 -0.00024122 0.01369872 0.15068111 0.01594691 -0.02353016 -0.02105510 -0.00028680 0.01625685 0.17604391 0.02099458 -0.03008391
        -0.07392512 0.00033847 0.00945927 0.01664999 0.19895500 0.05182727 -0.08991231 0.00039990 0.01101870 0.02099458 0.22070774 0.06273376
        -0.06808314 0.00035236 0.00802593 -0.02345786 0.05189742 0.11060487 -0.08165509 0.00041790 0.00922333 -0.03008391 0.06273376 0.13899387
    ] |> Hermitian rtol = 1e-3
    @test σ ≈ [
        0.5923219,
        0.0114418,
        0.3674867,
        0.4256361,
        0.4705127,
        0.3662926,
        0.5963286,
        0.0115994,
        0.3651883,
        0.4195759,
        0.4697954,
        0.3728188,
    ] rtol = 1e-4
end
